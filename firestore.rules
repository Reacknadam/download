rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get a user's role from their document in the 'users' collection.
    // This is crucial for role-based access control.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Helper function to check if a user is an admin.
    function isAdmin() {
      return request.auth != null && getUserRole(request.auth.uid) == 'admin';
    }

    // By default, most collections are locked down and can only be managed by administrators.
    // This provides a secure foundation.
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // --- Publicly Readable Collections ---

    // Courses and Playlists can be read by anyone if they are published.
    // This allows non-logged-in users to browse the catalog.
    match /courses/{courseId} {
      allow read: if resource.data.isPublished == true;
      // Writing is still restricted to admins.
      allow write: if isAdmin();
    }

    match /playlists/{playlistId} {
      allow read: if resource.data.isPublished == true;
      allow write: if isAdmin();
    }

    // Comments are readable by anyone.
    match /comments/{commentId} {
      allow read: if true;
      // Any authenticated user can create a comment, but cannot update or delete them.
      allow create: if request.auth != null;
    }


    // --- User-Specific Rules ---

    // Rules for the 'users' collection.
    match /users/{userId} {
      // A user can read their own document. Admins can read any user document.
      allow read: if request.auth.uid == userId || isAdmin();
      // An admin can update any user's role or details.
      allow update: if isAdmin();
      // A user can create their own document upon signup.
      allow create: if request.auth.uid == userId;
    }

    // Rules for the 'purchases' collection.
    match /purchases/{purchaseId} {
      // A user can read their own purchase history.
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // A user can create their own purchase document.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Rules for the 'kyc' (Know Your Customer) collection for teachers.
    match /kyc/{kycId} {
      // A user can create their own KYC submission.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
      // Only admins can read or update KYC documents.
      allow read, update: if isAdmin();
    }
  }
}
